service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() { return request.auth != null; }
    function isUserDoc() { return exists(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function getUserRole() { return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role; }
    function isOwnerRole() { return isSignedIn() && isUserDoc() && getUserRole() == 'OWNER'; }
    function isOwner(userId) { return request.auth.uid == userId; }

    // User Profile Rules
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isOwnerRole();
      allow update: if isSignedIn() && isOwner(userId) && request.resource.data.role == resource.data.role;
      allow write: if isOwnerRole();
    }

    // Business Collections
    match /clients/{clientId} {
      allow get: if isOwnerRole() || (isSignedIn() && resource.data.ownerId == request.auth.uid);
      allow list: if isOwnerRole() || isSignedIn();
      allow write: if isOwnerRole();
    }

    match /work-orders/{workOrderId} {
      allow get: if isOwnerRole() || (isSignedIn() && resource.data.ownerId == request.auth.uid);
      allow list: if isOwnerRole() || isSignedIn();
      allow write: if isOwnerRole();
    }

    match /masters/{masterId} {
      allow get: if isOwnerRole() || (isSignedIn() && resource.data.ownerId == request.auth.uid);
      allow list: if isOwnerRole() || isSignedIn();
      allow write: if isOwnerRole();
    }
  }
}